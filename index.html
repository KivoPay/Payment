{
  "name": "telegram-api-bot",
  "version": "1.0.0",
  "main": "index.js",
  "type": "module",
  "scripts": {
    "start": "node index.js"
  },
  "dependencies": {
    "axios": "^1.6.8",
    "dotenv": "^16.4.5",
    "telegraf": "^4.16.3"
  }
}
import 'dotenv/config';
import axios from 'axios';
import { Telegraf } from 'telegraf';

const BOT_TOKEN = process.env.BOT_TOKEN;
const API_BASE_URL = process.env.API_BASE_URL;   // contoh: https://api.provider.com/v1
const API_KEY = process.env.API_KEY;             // api key provider lu

if (!BOT_TOKEN) throw new Error("Missing BOT_TOKEN env");
if (!API_BASE_URL) throw new Error("Missing API_BASE_URL env");
if (!API_KEY) throw new Error("Missing API_KEY env");

const bot = new Telegraf(BOT_TOKEN);

const http = axios.create({
  baseURL: API_BASE_URL,
  timeout: 20000,
  headers: {
    "Authorization": `Bearer ${API_KEY}`,
    "Content-Type": "application/json"
  }
});

// Helper: format error biar ga bikin user nangis
function userErr(e) {
  const msg = e?.response?.data?.message || e?.response?.data?.error || e?.message || "Unknown error";
  return String(msg).slice(0, 300);
}

bot.start(async (ctx) => {
  await ctx.reply(
`Welcome.
Perintah:
• /saldo
• /produk
• /order <kode_produk> <qty>
• /status <order_id>`
  );
});

bot.command("help", (ctx) => ctx.reply("Ketik: /saldo /produk /order /status"));

bot.command("saldo", async (ctx) => {
  try {
    // Sesuaikan endpoint & response provider lu:
    // misal GET /balance => { balance: 12345 }
    const res = await http.get("/balance");
    const balance = res.data?.balance ?? res.data?.data?.balance;
    await ctx.reply(`Saldo: ${balance ?? "N/A"}`);
  } catch (e) {
    await ctx.reply(`Gagal cek saldo: ${userErr(e)}`);
  }
});

bot.command("produk", async (ctx) => {
  try {
    // misal GET /products => [{code,name,price}, ...]
    const res = await http.get("/products");
    const items = res.data?.data ?? res.data;

    if (!Array.isArray(items) || items.length === 0) {
      return ctx.reply("Produk kosong (atau endpoint-nya belum bener).");
    }

    const text = items
      .slice(0, 30)
      .map((p, i) => {
        const code = p.code ?? p.sku ?? p.id ?? "-";
        const name = p.name ?? p.title ?? "Produk";
        const price = p.price ?? p.amount ?? "-";
        return `${i + 1}. ${name}\n   Kode: ${code} | Harga: ${price}`;
      })
      .join("\n\n");

    await ctx.reply(text);
  } catch (e) {
    await ctx.reply(`Gagal ambil produk: ${userErr(e)}`);
  }
});

bot.command("order", async (ctx) => {
  try {
    const parts = ctx.message.text.trim().split(/\s+/);
    if (parts.length < 3) {
      return ctx.reply("Format: /order <kode_produk> <qty>");
    }
    const productCode = parts[1];
    const qty = Number(parts[2]);
    if (!Number.isFinite(qty) || qty <= 0) return ctx.reply("Qty harus angka > 0.");

    // misal POST /orders { product_code, qty } => { order_id, status }
    const res = await http.post("/orders", {
      product_code: productCode,
      qty
    });

    const orderId = res.data?.order_id ?? res.data?.data?.order_id ?? res.data?.id;
    const status = res.data?.status ?? res.data?.data?.status ?? "created";

    await ctx.reply(`Order dibuat.\nID: ${orderId ?? "N/A"}\nStatus: ${status}`);
  } catch (e) {
    await ctx.reply(`Gagal buat order: ${userErr(e)}`);
  }
});

bot.command("status", async (ctx) => {
  try {
    const parts = ctx.message.text.trim().split(/\s+/);
    if (parts.length < 2) return ctx.reply("Format: /status <order_id>");
    const orderId = parts[1];

    // misal GET /orders/:id => { status, ... }
    const res = await http.get(`/orders/${encodeURIComponent(orderId)}`);
    const status = res.data?.status ?? res.data?.data?.status ?? "N/A";

    await ctx.reply(`Status order ${orderId}: ${status}`);
  } catch (e) {
    await ctx.reply(`Gagal cek status: ${userErr(e)}`);
  }
});

bot.launch()
  .then(() => console.log("Bot running..."))
  .catch((e) => {
    console.error("Bot failed:", e);
    process.exit(1);
  });

// biar aman di host
process.once("SIGINT", () => bot.stop("SIGINT"));
process.once("SIGTERM", () => bot.stop("SIGTERM"));
